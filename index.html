<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SecondLife - Track Your Impact</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Manrope:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; }
    .font-heading { font-family: 'Space Grotesk', sans-serif; }
    .font-body { font-family: 'Manrope', sans-serif; }
    .gradient-hero { background: linear-gradient(165deg, #0f2027 0%, #203a43 50%, #2c5364 100%); }
    .card-glow {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: all 0.3s ease;
    }
    .card-glow:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(74, 222, 128, 0.3);
      transform: translateY(-2px);
    }
    .stat-card {
      background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
      border: 1px solid rgba(74, 222, 128, 0.2);
    }
    .action-btn { transition: all 0.2s ease; }
    .action-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(74, 222, 128, 0.3);
    }
    .action-btn:active { transform: scale(0.98); }
    .tab-btn {
      background: rgba(255, 255, 255, 0.05);
      color: #9ca3af;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .tab-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #e5e7eb;
    }
    .tab-active {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: white;
      border: 1px solid transparent;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in { animation: slideIn 0.3s ease-out; }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: rgba(74, 222, 128, 0.95);
      color: #0f2027;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: #4ade80;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .swap-btn {
      position: fixed;
      top: 70px;
      left: 16px;
      z-index: 100;
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color: white;
      padding: 10px 18px;
      border-radius: 12px;
      font-weight: 600;
      font-family: 'Manrope', sans-serif;
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 16px rgba(74, 222, 128, 0.3);
      transition: all 0.2s ease;
    }
    .swap-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 222, 128, 0.4);
    }
    .hidden { display: none !important; }
    
    /* Score Ring */
    .score-ring { position: relative; width: 140px; height: 140px; }
    .score-ring svg { transform: rotate(-90deg); }
    .score-ring circle { fill: none; stroke-width: 12; }
    .score-bg { stroke: rgba(255,255,255,0.1); }
    .score-progress {
      stroke: #4ade80;
      stroke-dasharray: 377;
      stroke-dashoffset: 377;
      transition: stroke-dashoffset 1s ease;
      stroke-linecap: round;
    }
    .score-text {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: #4ade80;
    }
    
    /* AI Result Cards */
    .ai-result-card {
      background: linear-gradient(135deg, rgba(74, 222, 128, 0.08) 0%, rgba(34, 197, 94, 0.03) 100%);
      border: 1px solid rgba(74, 222, 128, 0.2);
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
    }
    .idea-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: #e5e7eb;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      width: 100%;
    }
    .idea-chip:hover {
      background: rgba(74, 222, 128, 0.15);
      border-color: rgba(74, 222, 128, 0.4);
      transform: translateX(4px);
    }
    .step-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 12px 16px;
      border-radius: 12px;
      color: #e5e7eb;
    }
    .community-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 18px;
      transition: all 0.3s ease;
    }
    .community-card:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(74, 222, 128, 0.3);
      transform: translateY(-2px);
    }
    .community-tag {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(74, 222, 128, 0.2);
      color: #4ade80;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .impact-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(74, 222, 128, 0.15);
      border-radius: 8px;
      color: #4ade80;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .detail-panel {
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(74, 222, 128, 0.2);
      border-radius: 16px;
      padding: 20px;
      margin-top: 16px;
    }
    .back-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #4ade80;
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.15); }
    
    /* Auth Overlay */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 200;
    }
    .auth-overlay.hidden { display: none; }
    .auth-card {
      width: 100%;
      max-width: 420px;
      background: linear-gradient(165deg, #1a2f38 0%, #243b44 100%);
      border: 1px solid rgba(74, 222, 128, 0.2);
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 24px 48px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .auth-card h2 { margin: 0; color: #4ade80; font-family: 'Space Grotesk', sans-serif; }
    .auth-input {
      padding: 14px 16px;
      font-size: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      color: white;
      font-family: 'Manrope', sans-serif;
    }
    .auth-input::placeholder { color: rgba(255,255,255,0.4); }
    .auth-input:focus { outline: none; border-color: #4ade80; }
    .auth-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .auth-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-family: 'Manrope', sans-serif;
      transition: all 0.2s;
    }
    .auth-btn-primary {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color: white;
    }
    .auth-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(74, 222, 128, 0.3); }
    .auth-btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #4ade80;
    }
    .auth-btn-secondary:hover { background: rgba(255,255,255,0.15); }
    .auth-btn-ghost {
      background: transparent;
      color: #9ca3af;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .auth-btn-ghost:hover { background: rgba(255,255,255,0.05); color: white; }
    .auth-status { min-height: 20px; color: #4ade80; font-size: 0.95rem; font-family: 'Manrope', sans-serif; }
    .auth-status.error { color: #f87171; }
    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 8px 14px;
      border-radius: 12px;
    }
    .user-badge-name { color: #4ade80; font-weight: 600; font-family: 'Manrope', sans-serif; }
    .signout-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
      color: #9ca3af;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      font-family: 'Manrope', sans-serif;
      transition: all 0.2s;
    }
    .signout-btn:hover { background: rgba(255,255,255,0.05); color: white; }
  </style>
 </head>
 <body class="h-full">
  <!-- Auth Overlay -->
  <div class="auth-overlay" id="auth-overlay">
    <div class="auth-card">
      <h2>Welcome to SecondLife</h2>
      <input id="auth-username" class="auth-input" placeholder="Username" />
      <input id="auth-password" class="auth-input" type="password" placeholder="Password" />
      <div class="auth-actions">
        <button id="auth-login" class="auth-btn auth-btn-primary" type="button">Log in</button>
        <button id="auth-register" class="auth-btn auth-btn-secondary" type="button">Sign up</button>
        <button id="auth-skip" class="auth-btn auth-btn-ghost" type="button">Continue as Guest</button>
      </div>
      <div id="auth-status" class="auth-status"></div>
    </div>
  </div>

  <!-- User Badge (top left) -->
  <div id="user-badge-container" class="user-badge" style="position: fixed; top: 16px; left: 16px; z-index: 100;">
    <span id="user-badge" class="user-badge-name">Guest</span>
    <button id="signout-btn" class="signout-btn">Sign out</button>
    <button id="login-btn" class="signout-btn" style="display: none;">Sign up / Log in</button>
  </div>
  
  <div id="app-container" class="gradient-hero min-h-full w-full overflow-auto">
   <div class="max-w-5xl mx-auto px-4 py-8">
    <!-- Header -->
    <header class="text-center mb-10">
     <div class="inline-flex items-center gap-3 mb-3">
      <img src="secondlifelogo.png" alt="SecondLife Logo" class="w-[151px] h-[151px] rounded-lg object-contain">
     </div>
     <p class="font-body text-lg text-gray-300">AI-powered sustainability ‚Ä¢ Track your positive impact</p>
    </header>

    <!-- Daily Tip -->
    <div class="card-glow rounded-xl p-4 mb-6 flex items-center gap-4 flex-wrap">
      <div class="flex items-center gap-2 text-green-400">
        <span class="text-xl">üí°</span>
        <span class="font-heading font-semibold text-sm">Daily Tip</span>
      </div>
      <p id="daily-tip-text" class="font-body text-gray-300 text-sm flex-1 min-w-[200px]">Loading tip...</p>
      <div class="flex items-center gap-3 ml-auto">
        <span id="tip-timer" class="font-body text-xs text-gray-500">Next in 24:00:00</span>
        <button id="refresh-tip-btn" class="text-xs bg-green-500/20 hover:bg-green-500/30 text-green-400 px-3 py-1.5 rounded-lg font-semibold transition-all" title="Get new tip">üîÑ Refresh</button>
      </div>
    </div>

    <!-- Total Impact Stats -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
     <div class="stat-card rounded-2xl p-6 text-center">
      <div class="text-3xl font-bold font-heading text-green-400 mb-1" id="total-co2">0 kg</div>
      <div class="text-sm text-gray-300 font-body">CO‚ÇÇ Emissions Saved</div>
     </div>
     <div class="stat-card rounded-2xl p-6 text-center">
      <div class="text-3xl font-bold font-heading text-blue-400 mb-1" id="total-water">0 L</div>
      <div class="text-sm text-gray-300 font-body">Water Conserved</div>
     </div>
     <div class="stat-card rounded-2xl p-6 text-center">
      <div class="text-3xl font-bold font-heading text-amber-400 mb-1" id="total-waste">0 kg</div>
      <div class="text-sm text-gray-300 font-body">Waste Diverted</div>
     </div>
    </section>

    <!-- Tab Navigation -->
    <div class="flex justify-center gap-3 mb-8 flex-wrap">
      <button class="tab-btn tab-active font-heading px-6 py-3 rounded-xl font-semibold transition-all" data-tab="reuse">‚ôªÔ∏è Reuse</button>
      <button class="tab-btn font-heading px-6 py-3 rounded-xl font-semibold transition-all" data-tab="repair">üîß Repair</button>
      <button class="tab-btn font-heading px-6 py-3 rounded-xl font-semibold transition-all" data-tab="community">ü§ù Community</button>
      <button class="tab-btn font-heading px-6 py-3 rounded-xl font-semibold transition-all" data-tab="history">üìã History</button>
    </div>

    <!-- ==================== REUSE TAB ==================== -->
    <section id="reuse-tab" class="tab-content active">
      <div class="card-glow rounded-2xl p-6 mb-6">
        <h2 class="font-heading text-2xl font-semibold text-white mb-5">ü§ñ AI Reuse Analysis</h2>
        <div class="flex flex-col md:flex-row gap-4">
          <input type="text" id="reuse-item-input" placeholder="Enter an item or take a photo" 
            class="flex-1 px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white font-body placeholder-gray-500 focus:outline-none focus:border-green-400 focus:ring-2 focus:ring-green-400/20">
          <input type="file" id="reuse-photo-input" accept="image/*" capture="environment" class="hidden">
          <button id="photo-btn" class="action-btn bg-gradient-to-r from-blue-500 to-cyan-600 text-white font-semibold py-3 px-6 rounded-xl font-body flex items-center justify-center gap-2 whitespace-nowrap" title="Take or upload a photo">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span>üì∑</span>
          </button>
          <button id="analyze-reuse-btn" class="action-btn bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold py-3 px-8 rounded-xl font-body flex items-center justify-center gap-2 whitespace-nowrap">
            <span>Analyze Item</span>
          </button>
        </div>
        
        <!-- Photo Preview -->
        <div id="photo-preview-container" class="hidden mt-4">
          <div class="flex items-center gap-4">
            <img id="photo-preview" class="w-24 h-24 object-cover rounded-xl border-2 border-green-400/50" alt="Preview">
            <div class="flex-1">
              <p class="text-gray-300 font-body text-sm">Photo ready for analysis</p>
              <button id="remove-photo-btn" class="text-red-400 text-sm hover:text-red-300 mt-1">‚úï Remove photo</button>
            </div>
          </div>
        </div>
        
        <!-- Loading -->
        <div id="reuse-loading" class="hidden flex items-center justify-center gap-3 mt-6 text-gray-300">
          <div class="spinner"></div>
          <span class="font-body">AI is analyzing sustainability impact...</span>
        </div>
        
        <!-- AI Results -->
        <div id="reuse-ai-result" class="hidden ai-result-card">
          <div class="flex flex-col md:flex-row gap-6 items-start">
            <!-- Score Ring -->
            <div class="flex flex-col items-center">
              <div class="score-ring">
                <svg width="140" height="140">
                  <circle class="score-bg" cx="70" cy="70" r="60"/>
                  <circle id="reuse-score-circle" class="score-progress" cx="70" cy="70" r="60"/>
                </svg>
                <div id="reuse-score-text" class="score-text">0</div>
              </div>
              <div class="text-center mt-2">
                <div class="text-green-400 font-semibold font-heading">Eco Potential</div>
                <div class="text-gray-400 text-sm font-body">Higher = better reuse</div>
              </div>
            </div>
            
            <!-- Ideas -->
            <div class="flex-1">
              <h3 class="font-heading text-lg font-semibold text-white mb-3">üí° Reuse Ideas</h3>
              <div id="reuse-ideas-list" class="flex flex-col gap-3"></div>
              
              <!-- Detail Panel -->
              <div id="reuse-detail-panel" class="hidden detail-panel">
                <div class="flex items-center gap-3 mb-4">
                  <button id="reuse-back-btn" class="back-btn">‚Üê Back</button>
                  <h4 id="reuse-detail-title" class="font-heading text-lg font-semibold text-white"></h4>
                </div>
                <p id="reuse-detail-summary" class="text-gray-300 mb-4 font-body"></p>
                <div id="reuse-detail-steps" class="flex flex-col gap-2 mb-4"></div>
                <div id="reuse-detail-meta" class="text-gray-400 text-sm font-body"></div>
              </div>
            </div>
          </div>
          
          <!-- Impact -->
          <div id="reuse-impact" class="flex flex-wrap gap-3 mt-6"></div>
          
          <!-- Confirm Button -->
          <div class="mt-6 flex items-center gap-4">
            <button id="confirm-reuse-btn" class="action-btn bg-gradient-to-r from-green-600 to-emerald-700 text-white font-semibold py-3 px-6 rounded-xl font-body">
              ‚úÖ Confirm Reuse Action
            </button>
            <span id="reuse-points-added" class="hidden text-green-400 font-semibold">+<span id="points-value">0</span> points added!</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== REPAIR TAB ==================== -->
    <section id="repair-tab" class="tab-content">
      <div class="card-glow rounded-2xl p-6 mb-6">
        <h2 class="font-heading text-2xl font-semibold text-white mb-5">üîß AI Repair Guide</h2>
        <div class="flex flex-col md:flex-row gap-4">
          <input type="text" id="repair-item-input" placeholder="What needs repair? (e.g., laptop screen flickering, bike chain broken)" 
            class="flex-1 px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white font-body placeholder-gray-500 focus:outline-none focus:border-orange-400 focus:ring-2 focus:ring-orange-400/20">
          <button id="analyze-repair-btn" class="action-btn bg-gradient-to-r from-orange-500 to-red-500 text-white font-semibold py-3 px-8 rounded-xl font-body flex items-center justify-center gap-2 whitespace-nowrap">
            <span>Get Repair Guide</span>
          </button>
        </div>
        
        <!-- Loading -->
        <div id="repair-loading" class="hidden flex items-center justify-center gap-3 mt-6 text-gray-300">
          <div class="spinner"></div>
          <span class="font-body">Analyzing repair options...</span>
        </div>
        
        <!-- AI Results -->
        <div id="repair-ai-result" class="hidden ai-result-card">
          <div id="repair-issue" class="text-orange-400 font-semibold mb-4 font-heading"></div>
          
          <h3 class="font-heading text-lg font-semibold text-white mb-3">üìù Repair Steps</h3>
          <div id="repair-steps-list" class="flex flex-col gap-2 mb-6"></div>
          
          <div class="grid md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white/5 rounded-xl p-4">
              <div class="text-gray-400 text-sm mb-1 font-body">üõ†Ô∏è Tools Needed</div>
              <div id="repair-tools" class="text-white font-body"></div>
            </div>
            <div class="bg-white/5 rounded-xl p-4">
              <div class="text-gray-400 text-sm mb-1 font-body">üî© Parts Required</div>
              <div id="repair-parts" class="text-white font-body"></div>
            </div>
            <div class="bg-white/5 rounded-xl p-4">
              <div class="text-gray-400 text-sm mb-1 font-body">‚ö†Ô∏è Safety Notes</div>
              <div id="repair-safety" class="text-amber-400 font-body"></div>
            </div>
          </div>
          
          <button id="confirm-repair-btn" class="action-btn bg-gradient-to-r from-orange-600 to-red-600 text-white font-semibold py-3 px-6 rounded-xl font-body">
            ‚úÖ Mark as Repaired
          </button>
        </div>
      </div>
    </section>

    <!-- ==================== COMMUNITY TAB ==================== -->
    <section id="community-tab" class="tab-content">
      <div class="card-glow rounded-2xl p-6 mb-6">
        <h2 class="font-heading text-2xl font-semibold text-white mb-5">üåç Find Ways to Help</h2>
        <div class="flex flex-col md:flex-row gap-4">
          <input type="text" id="community-location-input" placeholder="Enter your city or location" 
            class="flex-1 px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white font-body placeholder-gray-500 focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400/20">
          <button id="find-community-btn" class="action-btn bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold py-3 px-8 rounded-xl font-body flex items-center justify-center gap-2 whitespace-nowrap">
            <span>Find Opportunities</span>
          </button>
        </div>
        
        <!-- Loading -->
        <div id="community-loading" class="hidden flex items-center justify-center gap-3 mt-6 text-gray-300">
          <div class="spinner"></div>
          <span class="font-body">Finding ways to help in your area...</span>
        </div>
        
        <!-- AI Results -->
        <div id="community-ai-result" class="hidden mt-6">
          <h3 class="font-heading text-xl font-semibold text-white mb-4">ü§ù Volunteer Opportunities</h3>
          <div id="community-list" class="grid gap-4"></div>
        </div>
      </div>
    </section>

    <!-- ==================== HISTORY TAB ==================== -->
    <section id="history-tab" class="tab-content">
      <div class="card-glow rounded-2xl p-6">
        <h2 class="font-heading text-2xl font-semibold text-white mb-5">üìã Your Actions</h2>
        <div id="actions-list" class="space-y-3">
          <div class="text-center py-12 text-gray-400 font-body">
            <svg class="w-16 h-16 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p>No actions logged yet. Use AI to analyze items and confirm your actions!</p>
          </div>
        </div>
      </div>
    </section>

   </div>
  </div>

  <script>
    // ==================== STATE ====================
    const STORAGE_KEY_PREFIX = 'secondlife_actions_';
    let allActions = [];
    let currentReuseData = null;
    let currentRepairData = null;
    let currentItem = '';

    // ==================== INIT ====================
    function init() {
      loadActions();
      setupTabs();
      setupEventListeners();
    }

    // ==================== STORAGE ====================
    function getStorageKey() {
      // If logged in, use user-specific key in localStorage
      // If guest, data is only in memory (resets on refresh)
      return currentUser ? STORAGE_KEY_PREFIX + currentUser : null;
    }

    function loadActions() {
      const key = getStorageKey();
      if (key) {
        // Logged in - load from localStorage
        try {
          const stored = localStorage.getItem(key);
          allActions = stored ? JSON.parse(stored) : [];
        } catch (e) {
          allActions = [];
        }
      } else {
        // Guest - start fresh (no persistence)
        allActions = [];
      }
      renderActionsList();
      updateTotalStats();
    }

    function saveActions() {
      const key = getStorageKey();
      if (key) {
        // Logged in - persist to localStorage
        localStorage.setItem(key, JSON.stringify(allActions));
      }
      // Guest - data stays in memory only
    }

    // ==================== TABS ====================
    function setupTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabName = btn.dataset.tab;
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
          btn.classList.add('tab-active');
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          document.getElementById(`${tabName}-tab`).classList.add('active');
        });
      });
    }

    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
      // Reuse
      document.getElementById('analyze-reuse-btn').addEventListener('click', analyzeReuse);
      document.getElementById('reuse-item-input').addEventListener('keypress', e => { if (e.key === 'Enter') analyzeReuse(); });
      document.getElementById('confirm-reuse-btn').addEventListener('click', confirmReuse);
      document.getElementById('reuse-back-btn').addEventListener('click', hideReuseDetail);
      
      // Photo upload
      document.getElementById('photo-btn').addEventListener('click', () => {
        document.getElementById('reuse-photo-input').click();
      });
      
      document.getElementById('reuse-photo-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            currentImageData = event.target.result;
            document.getElementById('photo-preview').src = currentImageData;
            document.getElementById('photo-preview-container').classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });
      
      document.getElementById('remove-photo-btn').addEventListener('click', () => {
        currentImageData = null;
        document.getElementById('reuse-photo-input').value = '';
        document.getElementById('photo-preview-container').classList.add('hidden');
      });
      
      // Repair
      document.getElementById('analyze-repair-btn').addEventListener('click', analyzeRepair);
      document.getElementById('repair-item-input').addEventListener('keypress', e => { if (e.key === 'Enter') analyzeRepair(); });
      document.getElementById('confirm-repair-btn').addEventListener('click', confirmRepair);
      
      // Community
      document.getElementById('find-community-btn').addEventListener('click', findCommunity);
      document.getElementById('community-location-input').addEventListener('keypress', e => { if (e.key === 'Enter') findCommunity(); });
    }

    // ==================== TOAST ====================
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast font-body';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ==================== STATS ====================
    function updateTotalStats() {
      const totalCO2 = allActions.reduce((sum, a) => sum + (a.co2_saved || 0), 0);
      const totalWater = allActions.reduce((sum, a) => sum + (a.water_saved || 0), 0);
      const totalWaste = allActions.reduce((sum, a) => sum + (a.waste_diverted || 0), 0);

      document.getElementById('total-co2').textContent = `${totalCO2.toFixed(1)} kg`;
      document.getElementById('total-water').textContent = `${totalWater.toFixed(1)} L`;
      document.getElementById('total-waste').textContent = `${totalWaste.toFixed(1)} kg`;
    }

    // ==================== REUSE AI ====================
    let currentImageData = null;
    
    async function analyzeReuse() {
      const item = document.getElementById('reuse-item-input').value.trim();
      if (!item && !currentImageData) {
        showToast('Please enter an item name or take a photo');
        return;
      }
      
      currentItem = item || 'item from photo';
      document.getElementById('reuse-loading').classList.remove('hidden');
      document.getElementById('reuse-ai-result').classList.add('hidden');
      
      try {
        const payload = { item: item || 'Identify this item from the image' };
        if (currentImageData) {
          payload.image = currentImageData;
        }
        
        const res = await fetch('/api/reuse', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!res.ok) throw new Error('API error');
        
        const data = await res.json();
        currentReuseData = data;
        
        // Use the AI-identified item name if we used a photo
        if (data.identifiedItem) {
          currentItem = data.identifiedItem;
        }
        
        // Update score ring
        const score = data.reuseScore || 0;
        const circle = document.getElementById('reuse-score-circle');
        const circumference = 2 * Math.PI * 60;
        circle.style.strokeDasharray = circumference;
        circle.style.strokeDashoffset = circumference - (score / 100) * circumference;
        document.getElementById('reuse-score-text').textContent = score;
        
        // Update ideas
        const ideasList = document.getElementById('reuse-ideas-list');
        ideasList.innerHTML = '';
        (data.ideas || []).forEach((idea, idx) => {
          const btn = document.createElement('button');
          btn.className = 'idea-chip';
          btn.innerHTML = `<span class="text-green-400">üí°</span> ${idea}`;
          btn.onclick = () => showIdeaDetail(idea);
          ideasList.appendChild(btn);
        });
        
        // Update impact
        const impact = data.impact || {};
        const impactDiv = document.getElementById('reuse-impact');
        const waste = impact.waste ?? impact.wasteKg ?? 'N/A';
        const co2 = impact.co2 ?? impact.CO2 ?? 'N/A';
        const water = impact.water ?? 'N/A';
        
        // Show identified item name if from photo
        const itemLabel = data.identifiedItem || currentItem;
        impactDiv.innerHTML = `
          ${data.identifiedItem ? `<div class="impact-badge bg-purple-500/20 text-purple-300">üîç ${data.identifiedItem}</div>` : ''}
          <div class="impact-badge">üå± Waste: ${waste}kg</div>
          <div class="impact-badge">üåç CO‚ÇÇ: ${co2}kg</div>
          <div class="impact-badge">üíß Water: ${water}L</div>
        `;
        
        // Clear photo after successful analysis
        currentImageData = null;
        document.getElementById('reuse-photo-input').value = '';
        document.getElementById('photo-preview-container').classList.add('hidden');
        
        document.getElementById('reuse-loading').classList.add('hidden');
        document.getElementById('reuse-ai-result').classList.remove('hidden');
        document.getElementById('reuse-points-added').classList.add('hidden');
        
      } catch (err) {
        console.error('Reuse error:', err);
        document.getElementById('reuse-loading').classList.add('hidden');
        showToast('Error analyzing item. Please try again.');
      }
    }

    async function showIdeaDetail(idea) {
      document.getElementById('reuse-ideas-list').classList.add('hidden');
      document.getElementById('reuse-detail-panel').classList.remove('hidden');
      document.getElementById('reuse-detail-title').textContent = idea;
      document.getElementById('reuse-detail-summary').textContent = 'Loading details...';
      document.getElementById('reuse-detail-steps').innerHTML = '<div class="spinner mx-auto"></div>';
      document.getElementById('reuse-detail-meta').textContent = '';
      
      try {
        const res = await fetch('/api/reuse/detail', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item: currentItem, idea })
        });
        
        if (!res.ok) throw new Error('API error');
        
        const data = await res.json();
        
        document.getElementById('reuse-detail-summary').textContent = data.summary || '';
        
        const stepsDiv = document.getElementById('reuse-detail-steps');
        stepsDiv.innerHTML = '';
        (data.steps || []).forEach((step, idx) => {
          const stepEl = document.createElement('div');
          stepEl.className = 'step-item';
          stepEl.innerHTML = `<span class="text-green-400 font-bold">${idx + 1}.</span> ${step}`;
          stepsDiv.appendChild(stepEl);
        });
        
        const meta = [];
        if (data.time) meta.push(`‚è±Ô∏è ${data.time}`);
        if (data.difficulty) meta.push(`üìä Difficulty: ${data.difficulty}/5`);
        if (data.materials && data.materials.length) meta.push(`üß∞ Materials: ${data.materials.join(', ')}`);
        document.getElementById('reuse-detail-meta').textContent = meta.join(' ‚Ä¢ ');
        
      } catch (err) {
        document.getElementById('reuse-detail-summary').textContent = 'Could not load details.';
        document.getElementById('reuse-detail-steps').innerHTML = '';
      }
    }

    function hideReuseDetail() {
      document.getElementById('reuse-detail-panel').classList.add('hidden');
      document.getElementById('reuse-ideas-list').classList.remove('hidden');
    }

    function confirmReuse() {
      if (!currentReuseData) return;
      
      const impact = currentReuseData.impact || {};
      const action = {
        type: 'reuse',
        item: currentItem,
        description: `Reused: ${currentItem}`,
        score: currentReuseData.reuseScore || 0,
        co2_saved: parseFloat(impact.co2 || impact.CO2 || 0) || 0,
        water_saved: parseFloat(impact.water || 0) || 0,
        waste_diverted: parseFloat(impact.waste || impact.wasteKg || 0) || 0,
        ideas: currentReuseData.ideas || [],
        date: new Date().toISOString(),
        timestamp: Date.now()
      };
      
      allActions.push(action);
      saveActions();
      updateTotalStats();
      renderActionsList();
      
      document.getElementById('points-value').textContent = action.score;
      document.getElementById('reuse-points-added').classList.remove('hidden');
      showToast(`+${action.score} points! Reuse action logged! üéâ`);
    }

    // ==================== REPAIR AI ====================
    async function analyzeRepair() {
      const description = document.getElementById('repair-item-input').value.trim();
      if (!description) return;
      
      document.getElementById('repair-loading').classList.remove('hidden');
      document.getElementById('repair-ai-result').classList.add('hidden');
      
      try {
        const res = await fetch('/api/repair', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ description })
        });
        
        if (!res.ok) throw new Error('API error');
        
        const data = await res.json();
        currentRepairData = { ...data, description };
        
        document.getElementById('repair-issue').textContent = data.likelyIssue ? `üîç Likely Issue: ${data.likelyIssue}` : '';
        
        const stepsList = document.getElementById('repair-steps-list');
        stepsList.innerHTML = '';
        (data.steps || []).forEach((step, idx) => {
          const stepEl = document.createElement('div');
          stepEl.className = 'step-item';
          stepEl.innerHTML = `<span class="text-orange-400 font-bold">${idx + 1}.</span> ${step}`;
          stepsList.appendChild(stepEl);
        });
        
        const tools = (data.requiredTools || []).filter(Boolean);
        const parts = (data.replacementParts || []).filter(Boolean);
        const safety = (data.safetyNotes || []).filter(Boolean);
        
        document.getElementById('repair-tools').textContent = tools.length ? tools.join(', ') : 'None specified';
        document.getElementById('repair-parts').textContent = parts.length ? parts.join(', ') : 'None specified';
        document.getElementById('repair-safety').textContent = safety.length ? safety.join('; ') : 'Follow standard precautions';
        
        document.getElementById('repair-loading').classList.add('hidden');
        document.getElementById('repair-ai-result').classList.remove('hidden');
        
      } catch (err) {
        console.error('Repair error:', err);
        document.getElementById('repair-loading').classList.add('hidden');
        showToast('Error getting repair guide. Please try again.');
      }
    }

    function confirmRepair() {
      if (!currentRepairData) return;
      
      const action = {
        type: 'repair',
        description: `Repaired: ${currentRepairData.description}`,
        issue: currentRepairData.likelyIssue || '',
        co2_saved: 2.5, // Estimated average
        water_saved: 10,
        waste_diverted: 1.5,
        date: new Date().toISOString(),
        timestamp: Date.now()
      };
      
      allActions.push(action);
      saveActions();
      updateTotalStats();
      renderActionsList();
      showToast('Repair action logged! üîß');
    }

    // ==================== COMMUNITY AI ====================
    async function findCommunity() {
      const location = document.getElementById('community-location-input').value.trim();
      if (!location) return;
      
      document.getElementById('community-loading').classList.remove('hidden');
      document.getElementById('community-ai-result').classList.add('hidden');
      
      try {
        const res = await fetch('/api/community', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ location })
        });
        
        if (!res.ok) throw new Error('API error');
        
        const data = await res.json();
        
        const list = document.getElementById('community-list');
        list.innerHTML = '';
        
        (data.opportunities || []).forEach(opp => {
          const card = document.createElement('div');
          card.className = 'community-card';
          card.innerHTML = `
            <span class="community-tag">${opp.type || 'Community'}</span>
            <h4 class="font-heading text-xl font-semibold text-white mb-2">${opp.name || 'Opportunity'}</h4>
            <p class="text-gray-300 font-body mb-3">${opp.description || ''}</p>
            <div class="flex flex-wrap gap-4 text-sm text-gray-400 font-body mb-3">
              ${opp.location ? `<span>üìç ${opp.location}</span>` : ''}
              ${opp.commitment ? `<span>‚è∞ ${opp.commitment}</span>` : ''}
            </div>
            ${opp.impact ? `<p class="text-green-400 text-sm font-body"><strong>Impact:</strong> ${opp.impact}</p>` : ''}
          `;
          list.appendChild(card);
        });
        
        document.getElementById('community-loading').classList.add('hidden');
        document.getElementById('community-ai-result').classList.remove('hidden');
        
      } catch (err) {
        console.error('Community error:', err);
        document.getElementById('community-loading').classList.add('hidden');
        showToast('Error finding opportunities. Please try again.');
      }
    }

    // ==================== ACTIONS LIST ====================
    function renderActionsList() {
      const listContainer = document.getElementById('actions-list');
      
      if (allActions.length === 0) {
        listContainer.innerHTML = `
          <div class="text-center py-12 text-gray-400 font-body">
            <svg class="w-16 h-16 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p>No actions logged yet. Use AI to analyze items and confirm your actions!</p>
          </div>
        `;
        return;
      }

      const sorted = [...allActions].sort((a, b) => b.timestamp - a.timestamp);
      
      listContainer.innerHTML = sorted.map(action => {
        const date = new Date(action.date);
        const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const icon = action.type === 'reuse' ? '‚ôªÔ∏è' : action.type === 'repair' ? 'üîß' : 'ü§ù';
        const color = action.type === 'reuse' ? 'green' : action.type === 'repair' ? 'orange' : 'blue';
        
        return `
          <div class="card-glow rounded-xl p-4 slide-in">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">${icon}</span>
                  <h3 class="font-semibold text-white font-heading">${action.description}</h3>
                  ${action.score ? `<span class="text-${color}-400 text-sm font-bold">+${action.score}</span>` : ''}
                </div>
                <div class="flex flex-wrap gap-3 text-sm font-body">
                  ${action.co2_saved > 0 ? `<span class="text-green-400">üåç ${action.co2_saved}kg CO‚ÇÇ</span>` : ''}
                  ${action.water_saved > 0 ? `<span class="text-blue-400">üíß ${action.water_saved}L water</span>` : ''}
                  ${action.waste_diverted > 0 ? `<span class="text-amber-400">‚ôªÔ∏è ${action.waste_diverted}kg waste</span>` : ''}
                </div>
                <div class="text-xs text-gray-500 mt-2 font-body">${formattedDate}</div>
              </div>
              <button onclick="deleteAction(${action.timestamp})" class="text-red-400 hover:text-red-300 transition-colors p-2 hover:bg-white/5 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    window.deleteAction = function(timestamp) {
      allActions = allActions.filter(a => a.timestamp !== timestamp);
      saveActions();
      renderActionsList();
      updateTotalStats();
      showToast('Action deleted');
    };

    // ==================== AUTH ====================
    const APP_USER_KEY = 'secondlife_user';
    const APP_POINTS_KEY = 'secondlife_user_points';
    let currentUser = null;
    let userPoints = { reuse: 0, repair: 0 };
    
    const authOverlay = document.getElementById('auth-overlay');
    const authUser = document.getElementById('auth-username');
    const authPass = document.getElementById('auth-password');
    const authStatus = document.getElementById('auth-status');
    const userBadge = document.getElementById('user-badge');
    const signoutBtn = document.getElementById('signout-btn');

    function updateUserBadge() {
      userBadge.textContent = currentUser || 'Guest';
      const loginBtn = document.getElementById('login-btn');
      if (currentUser) {
        signoutBtn.style.display = 'inline-block';
        loginBtn.style.display = 'none';
      } else {
        signoutBtn.style.display = 'none';
        loginBtn.style.display = 'inline-block';
      }
    }

    function setUser(name, showOverlay = false, points) {
      const wasLoggedIn = !!currentUser;
      currentUser = name || null;
      userPoints = points || userPoints;
      if (!currentUser) {
        userPoints = { reuse: 0, repair: 0 };
        // Clear actions when signing out or going to guest
        allActions = [];
        renderActionsList();
        updateTotalStats();
      } else {
        // Load this user's saved actions
        loadActions();
      }
      updateUserBadge();
      // Don't persist login to localStorage - login clears on refresh
      if (showOverlay) {
        authOverlay.classList.remove('hidden');
      } else {
        authOverlay.classList.add('hidden');
      }
    }

    async function authRequest(path) {
      const username = authUser.value.trim();
      const password = authPass.value.trim();
      if (!username || !password) {
        authStatus.textContent = 'Enter username and password';
        authStatus.classList.add('error');
        return;
      }
      authStatus.textContent = 'Working...';
      authStatus.classList.remove('error');
      try {
        const resp = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await resp.json();
        if (!resp.ok) {
          authStatus.textContent = data && data.error ? data.error : 'Auth failed';
          authStatus.classList.add('error');
          return;
        }
        setUser(data.username, false, { reuse: data.reusePoints || 0, repair: data.repairPoints || 0 });
        authStatus.textContent = '';
        showToast(`Welcome back, ${data.username}! üå±`);
      } catch (e) {
        authStatus.textContent = 'Network error';
        authStatus.classList.add('error');
      }
    }

    document.getElementById('auth-login').addEventListener('click', () => authRequest('/api/auth/login'));
    document.getElementById('auth-register').addEventListener('click', () => authRequest('/api/auth/register'));
    document.getElementById('auth-skip').addEventListener('click', () => {
      setUser(null);
      authStatus.textContent = '';
    });

    signoutBtn.addEventListener('click', () => {
      setUser(null, true);
      authStatus.textContent = '';
      authUser.value = '';
      authPass.value = '';
    });

    document.getElementById('login-btn').addEventListener('click', () => {
      authOverlay.classList.remove('hidden');
      authStatus.textContent = '';
      authUser.value = '';
      authPass.value = '';
    });

    // Always start fresh on page load - user must log in each session
    function initAuth() {
      // Clear any old session data
      currentUser = null;
      allActions = [];
      // Show auth overlay - user must log in or continue as guest
      authOverlay.classList.remove('hidden');
      updateUserBadge();
    }

    // ==================== DAILY TIP ====================
    const sustainabilityTips = [
      "Bring reusable bags when shopping - a single plastic bag takes up to 1,000 years to decompose.",
      "Unplug electronics when not in use - phantom power can account for 10% of your electricity bill.",
      "Take shorter showers - cutting just 2 minutes saves up to 10 gallons of water per shower.",
      "Use a reusable water bottle - the average person can save 156 plastic bottles per year.",
      "Compost food scraps - this can reduce household waste by up to 30%.",
      "Buy second-hand clothes - the fashion industry produces 10% of global carbon emissions.",
      "Air dry your clothes when possible - dryers account for 6% of household energy use.",
      "Fix leaky faucets - a dripping tap wastes up to 3,000 gallons of water per year.",
      "Choose products with minimal packaging - packaging makes up about 30% of municipal waste.",
      "Eat more plant-based meals - reducing meat consumption by half cuts your food carbon footprint by 40%.",
      "Use LED bulbs - they use 75% less energy and last 25 times longer than incandescent bulbs.",
      "Repair before replacing - extending product life by 9 months reduces its carbon footprint by 20-30%.",
      "Donate items you no longer need - this keeps them out of landfills and helps others.",
      "Use public transport or bike when possible - one bus can replace 40 cars on the road.",
      "Buy local produce - food that travels shorter distances has a smaller carbon footprint.",
      "Turn off lights when leaving a room - lighting accounts for 10% of home electricity use.",
      "Use cloth napkins instead of paper - the average person uses 2,200 paper napkins per year.",
      "Collect rainwater for plants - outdoor watering accounts for 30% of household water use.",
      "Choose rechargeable batteries - they can be reused 500-1,000 times.",
      "Say no to single-use plastics - 8 million tons of plastic enter our oceans every year."
    ];

    const TIP_STORAGE_KEY = 'secondlife_daily_tip';
    const TIP_INTERVAL = 24 * 60 * 60 * 1000; // 24 hours in ms
    let tipTimerInterval;

    function getTipData() {
      const stored = localStorage.getItem(TIP_STORAGE_KEY);
      if (stored) {
        return JSON.parse(stored);
      }
      return null;
    }

    function saveTipData(tipIndex, timestamp) {
      localStorage.setItem(TIP_STORAGE_KEY, JSON.stringify({ tipIndex, timestamp }));
    }

    function getRandomTipIndex(excludeIndex = -1) {
      let newIndex;
      do {
        newIndex = Math.floor(Math.random() * sustainabilityTips.length);
      } while (newIndex === excludeIndex && sustainabilityTips.length > 1);
      return newIndex;
    }

    function updateTipDisplay(tipIndex) {
      document.getElementById('daily-tip-text').textContent = sustainabilityTips[tipIndex];
    }

    function updateTimerDisplay(remainingMs) {
      const hours = Math.floor(remainingMs / (1000 * 60 * 60));
      const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);
      const formatted = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      document.getElementById('tip-timer').textContent = `Next in ${formatted}`;
    }

    function startTipTimer(targetTime) {
      if (tipTimerInterval) clearInterval(tipTimerInterval);
      
      tipTimerInterval = setInterval(() => {
        const remaining = targetTime - Date.now();
        if (remaining <= 0) {
          // Time's up, get a new tip
          clearInterval(tipTimerInterval);
          const currentData = getTipData();
          const newIndex = getRandomTipIndex(currentData ? currentData.tipIndex : -1);
          const newTimestamp = Date.now();
          saveTipData(newIndex, newTimestamp);
          updateTipDisplay(newIndex);
          startTipTimer(newTimestamp + TIP_INTERVAL);
        } else {
          updateTimerDisplay(remaining);
        }
      }, 1000);
    }

    function refreshTipEarly() {
      const currentData = getTipData();
      const newIndex = getRandomTipIndex(currentData ? currentData.tipIndex : -1);
      const newTimestamp = Date.now();
      saveTipData(newIndex, newTimestamp);
      updateTipDisplay(newIndex);
      startTipTimer(newTimestamp + TIP_INTERVAL);
      showToast('New tip loaded! üí°');
    }

    function initDailyTip() {
      const tipData = getTipData();
      const now = Date.now();
      
      if (tipData && (now - tipData.timestamp) < TIP_INTERVAL) {
        // Use existing tip, continue countdown
        updateTipDisplay(tipData.tipIndex);
        startTipTimer(tipData.timestamp + TIP_INTERVAL);
      } else {
        // Need a new tip
        const newIndex = getRandomTipIndex(tipData ? tipData.tipIndex : -1);
        saveTipData(newIndex, now);
        updateTipDisplay(newIndex);
        startTipTimer(now + TIP_INTERVAL);
      }
      
      document.getElementById('refresh-tip-btn').addEventListener('click', refreshTipEarly);
    }

    // ==================== START ====================
    initAuth();
    init();
    initDailyTip();
  </script>
 </body>
</html>
